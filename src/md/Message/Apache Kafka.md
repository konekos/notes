# Apache Kafka

## 第1 章 初识Kafka

### 1. 1 发布与订阅消息系统

数据（消息）的发送者（发布者）不会直接把消息发送给接收者，这是发布与订阅消息系统的一个特点。发布者以某种方式对消息进行分类，接收者（订阅者）订阅它们，以便接收特定类型的消息。发布与订阅系统一般会有一个broker ，也就是发布消息的中心点。

#### 1 .1 .1 如何开始

![1547114410918](E:\studydyup\notes\src\pic\1547114410918.png)

#### 1.1.2 独立的队列系统

![1547114492140](E:\studydyup\notes\src\pic\1547114492140.png)

### 1.2 Kafka 登场

​	Kafka 就是为了解决上述问题而设计的一款基于发布与订阅的梢息系统。它一般被称为“分布式提交臼志”或者“分布式流平台”。文件系统或数据库提交日志用来提供所有事务的持久记录， 通过重放这些日志可以重建系统的状态。同样地， Kafka 的数据是按照一定顺序持久化保存的，可以按需读取。此外， Kafka 的数据分布在整个系统里，具备数据故障保护和性能伸缩能力。

#### 1.2.1 消息和批次

Kafka 的数据单元被称为消息。如果你在使用Kafka 之前已经有数据库使用经验，那么可以把消息看成是数据库里的一个“数据行”或一条“ 记录”。

为了提高效率，消息被分批次写入Kafka 。批次就是一组消息，这些消息属于同一个主题和分区。。如果每一个消息都单独穿行于网络，会导致大量的网络开销，把消息分成批次传输可以减少网络开销。不过，这要在时间延迟和吞吐量之间作出权衡：批次越大，单位时间内处理的消息就越多，单个消息的传输时间就越长。批次数据会被压缩，这样可以提升数据的传输和存储能力，但要做更多的计算处理。

#### 1.2.2 模式

对于Kafka 来说，消息不过是晦涩难懂的字节数组，所以有人建议用一些额外的结构来定义消息内容，让它们更易于理解。根据应用程序的需求， 1肖息模式（ schema ）有许多可用的选项。像JSON 和XML 这些简单的系统，不仅易用，而且可读性好。

#### 1. 2.3 主题和分区

Kafka 的悄息通过主题进行分类。主题就好比数据库的表，或者文件系统里的文件夹。

主题可以被分为若干个分区， 一个分区就是一个提交日志。消息以追加的方式写入分区，然后以先入先出的顺序读取。要注意，由于一个主题一般包含几个分区，因此无撞在整个主题范围内保证消息的顺序，但可以保证消息在单个分区内的顺序。图1 -5 所示的主题有4个分区，消息被迫加写入每个分区的尾部。K aflca 通过分区来实现数据冗余和伸缩性。分区可以分布在不同的服务器上，也就是说， 一个主题可以横跨多个服务器，以此来提供比单个服务器更强大的性能。

![1547115831932](E:\studydyup\notes\src\pic\1547115831932.png)



我们通常会使用流这个词来描述Kaflca 这类系统的数据。很多时候， 人们把一个主题的数据看成一个流，不管它有多少个分区。流是一组从生产者移动到消费者的数据。当我们讨论流式处理时，一般都是这样描述消息的。Kafka Streams 、Apache Samza 和Storm 这些框架以实时的方式处理消息，也就是所谓的流式处理。我们可以将流式处理与离线处理进行比较，比如Hadoop 就是被设计用于在稍后某个时刻处理大量的数据。

#### 1. 2.4 生产者和消费者

Kaflca 的客户端就是Kaflea 系统的用户，它们被分为两种基本类型： 生产者和消费者。

除此之外，还有其他高级客户端API －←用于数据集成的Kaflca Co nn ect API 和用于流式处理的Kaflca Streams 。这些高级客户端API 使用生产者和消费者作为内部组件，提供了高级的功能。

生产者创建消息。一般情况下，一个消息会被发布到一个特定的主题上。生产者在默认情况下把消息均衡地分布到主题的所有分区上，而并不关心特定消息会被写到哪个分区。不过，在某些情况下，生产者会把消息直接写到指定的分区。这通常是通过消息键和分区器来实现的，分区器为键生成一个散列值，并将其映射到指定的分区上。这样可以保证包含同一个键的消息会被写到同一个分区上。生产者也可以使用自定义的分区器，根据不同的业务规则将消息映射到分区。

消费者读取消息。消费者订阅一个或多个主题，并按照消息生成的顺序读取它们。消费者通过检查消息的偏移量来区分已经读取过的消息。偏移量是另一种元数据，它是一个不断递增的整数值，在创建消息时， Kafka 会把它添加到消息里。在给定的分区里，每个悄息的偏移量都是唯一的。消费者把每个分区最后读取的悄息偏移量保存在Zoo keeper 或Kafka 上，如果悄费者关闭或重启，它的读取状态不会丢失。





